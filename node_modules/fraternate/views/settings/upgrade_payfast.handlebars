<style type="text/css">
.awesome {
	padding: 2px;
	border-radius: 5px;
	background: #5cb85c;
}
</style>
<div class="row">
	<div class="col-md-3">
		<h3>Upgrade your plan</h3>
		<div>
			<div>  
				<a href="/{{user.username}}">
					{{#if user.image}}
					<div onerror="this.src='{{user.gravatar}}'"" id="googlepic" style="min-width: 25%"></div>
					{{else}}
					<img src="{{user.gravatar}}" class="media-object">
					{{/if}}
				</a>
			</div>
		</div>
		
		{{#if user.plan.payfast.payment_status}}
		<h5>Current plan</h5>
		<strong>Developer</strong>, Unlimited private repositories
		{{else}}
		<h4>{{user.name}} {{user.lastname}}  <small>{{user.username}}</small></h4>
		<hr>
		<h5>Current plan</h5>
		<strong>Free plan</strong>, Unlimited public repositories</strong>
		<hr>
		<h5>Upgrading to</h5>
		<strong>Developer</strong>, Unlimited private repositories
	</strong>
	<hr>
	<h5>New plan price</h5>
	<h1 id="pricing">ZAR 100.00 / Month</h1>
	{{/if}}
</div>
<div class="col-md-9">
	{{#if messages.success}}
	<div role="alert" class="alert alert-success">
		{{#each messages.success}}
		<div>{{msg}}</div>
		{{/each}}
	</div>
	{{/if}}
	{{#if messages.error}}
	<div role="alert" class="alert alert-danger">
		{{#each messages.error}}
		<div>{{msg}}</div>
		{{/each}}
	</div>
	{{/if}}
	{{#if user.plan.payfast.payment_status}}
	<div class="col-md-12" style="">
		<h2>Edit your subscription</h2>
		<div class="well">
			<strong>Developer</strong>, Unlimited private repositories</strong>
		</div>
		<a class="btn btn-outline-secondary" href="/users/{{user.username}}/cancel_subscription">Cancel Subscription</a></div>
		{{else}}
		<h2>Billing</h2>
		<hr> 
		<div class="row">
			<div class="col-md-12" style="">
				<p>
				</p>
				<h3>Select your prefered billing period.</h3>
				<p>
				</p>
				<div class="row">
					<div class="col-md-6">
						<div class="awesome">
							<div class="panel panel-default" style="margin-bottom: 1px;border-color: #5cb85c; "  >
								<div class="panel-body" >
									Charge today
									<h1 id="pricingNow">ZAR 100.00  / Month</h1>
									<a class="btn btn-outline-secondary" data-price="100.00" data-cycles="0" data-frequency="3" id="btn1" onclick="price(this.id)" >
										Select
									</a>
								</div>
								<div class="panel-footer">Your next charge will be on <span id="dates"></span>.</div>
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<div class="awesome">
							<div class="panel panel-default" style="margin-bottom: 1px;border-color: #5cb85c; "  >
								<div class="panel-body" >
									Charge today
									<h1 id="pricingNow">ZAR 1 200.00 / Year</h1>
									<a class="btn btn-outline-secondary collapsed" data-price="1200.00" data-cycles="0" data-frequency="6" id="btn2" onclick="price(this.id)" >
										Select
									</a>								
								</div>
								<div class="panel-footer">Your next charge will be on <span id="years"></span>.</div>
							</div>
						</div>
					</div>
				</div>
				<p>
				</p>
			</div>	
	
		<div class="panel-body" >
			<p></p>
			<input class="form-control" type="hidden" name="payfast_url" id="payfast_url" value="{{URLPAYFAST}}">
			<input class="form-control" type="hidden" name="merchant_id" id="merchant_id" value="{{MERCHANTIDPAYFAST}}">
			<input class="form-control" type="hidden" name="merchant_key" id="merchant_key" value="{{MERCHANTKEYPAYFAST}}">
            <input class="form-control" type="hidden" name="return_url" id="return_url" value="https://fraternate.herokuapp.com/payment_finished">
            <input class="form-control" type="hidden" name="cancel_url" id="cancel_url" value="https://fraternate.herokuapp.com/payment_cancelled">
            <input class="form-control" type="hidden" name="notify_url" id="notify_url" value="https://fraternate.herokuapp.com/payment_notify">
            <input type="hidden" name="item_name" id="item_name" value="Single User - Subscription">    
            <input type="hidden" name="subscription_type" id="subscription_type" value="1">       
            <input type="hidden" name="frequency" id="frequency" value="6">      
            <input type="hidden" name="cycles" id="cycles" value="0"> 
            <input type="hidden" name="m_subscription_id" name="m_subscription_id" value="pay_now_12600984">
            <input type="hidden" name="m_payment_id"  name="m_payment_id" value="pay_now_12600984"> 
            <input class="form-control" type="hidden" name="item_name" id="item_name" value="Subscription">
            <input class="form-control" type="hidden" name="item_description" id="item_description" value="">
            <input class="form-control" type="hidden" name="email_confirmation" id="email_confirmation" value="1">
            <input class="form-control" type="hidden" name="confirmation_address" id="confirmation_address" value="{{user.email}}">
            <p></p>
            <div> 
              <div class="form-horizontal">
               <div class="form-group">
                <label class="col-md-4 control-label" for="textinput">Amount (Rand): </label>  
                <div class="col-md-8">
                 <input class="form-control" type="text" name="amount" id="amount" value="1200.00" disabled />
               </div>
             </div>
             <div class="form-group">
              <label class="col-md-4 control-label" for="textinput">First Name: </label>  
              <div class="col-md-8">
               <input class="form-control" type="text" name="name_first" id="name_first" value="{{user.name}}" />
             </div>
           </div>
           <div class="form-group">
            <label class="col-md-4 control-label" for="textinput">Last Name: </label>  
            <div class="col-md-8">
              <input class="form-control" type="text" name="name_last" id="name_last" value="{{user.lastname}}" />
            </div>
          </div>
          <div class="form-group">
            <label class="col-md-4 control-label" for="textinput">Receipt Email: </label>  
            <div class="col-md-8">
             <input class="form-control" type="text" name="email_address" id="email_address" value="{{user.email}}" />
           </div>
         </div>
       </div>
       <table class="table table-bordered">
        <tr style="display: none">
          <td>Invoice Number: </td>
          <td>
            <input class="form-control" type="text" name="payment_id" id="payment_id" value="{{user._id}}" />
          </td>
        </tr>
        <tr style="display: none">
          <td>User Email: </td>
          <td>
            <input class="form-control" type="text" name="custom_str1" id="custom_str1" value="{{user.email}}" />
          </td>
        </tr>
        <tr style="display: none">
          <td>User ID: </td>
          <td>
            <input class="form-control" type="text" name="custom_str2" id="custom_str2" value="{{user._id}}" />
          </td>
        </tr>    
      </table>                
      <img onclick="quickPostPaymentToPayFast(document.getElementById('payfast_url').value);" src="https://sandbox.payfast.co.za/images/buttons/dark-large-subscribe.png"width="210" height="59" alt="Subscribe Now" title="Subscribe Now with PayFast" style="cursor: pointer;" />
      <p></p>
      <small class="text-muted">By clicking "Subscribe Now via PayFast",  up, you agree to the <a href="/terms">Terms of Service</a> and <a href="/Privacy">Privacy Statement</a>. You will be forwarded to the PayFast payment gateway.</small> 
				</p>         
			</div>
		</div>
	</div>
</div>
	</div>
{{/if}}	


<div id='buttonss'></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script type="text/javascript">
	var username = JSON.stringify('{{user.username}}')
	var user = JSON.stringify('{{user.username}}')
	var text = '{{user.image}}'
	text =text.replace("sz&#x3D;50", "sz&#x3D;200");
	$('#googlepic').html('<img src="'+text+'" style="max-width: 50%;border-radius: 2px;border: 1px;border-color: #d8d8d8;border-style: solid;" class="media-object">')
	var checkout;
//////////////////////////////////////////////////////
////        AJAX SUBMIT THE FORM - CREATE        //// 
////////////////////////////////////////////////////
function formPost(payload){
	var moredata = payload.nonce;
	$input = $('<input type="text" name="payload" style="display:none"/>').val(moredata);
	$('#theForm').append($input);
	var datastring = $('#theForm').serialize()
	$.ajax({
		type: "POST",
		url: '/users/'+username+'/subscription',
		data: datastring,
		dataType: "json",
		success: function(data) {
			window.location = '/users/'+username+'/settings/billing';	
		},
		error : function(err){
			console.log('Not working')
			window.location = '/users/'+username+'/settings/billing';	
		}
	}); 
}
////////////////////////
///// INITIALIZE //////
//////////////////////
$(document).ready( function() {
	months()
	years()
});
function price(ids){
	var price = $('#'+ids).data('price')
	var cycles = $('#'+ids).data('cycles')
	var frequency = $('#'+ids).data('frequency')
	console.log(price,cycles)
	$('#cycles').val(cycles)
	$('#amount').val(price)
	$('#frequency').val(frequency)
}
////////////////////////////////
///// HANDLING THE DATES //////
//////////////////////////////
function months(){
	var datevalue = moment().add(1, 'M').format('YYYY-MM-DD');
	$('#dates').html(datevalue)
}
////////////////////////////////
///// HANDLING THE DATES //////
//////////////////////////////
function years(){
	var datevalue = moment().add(1, 'Y').format('YYYY-MM-DD');
	$('#years').html(datevalue)
}
	/*
	Super simple PayFast JS implementation with zero dependencies to other libraries.
	Certain functions pulled from all over the internet.
	*/
	var createElement = (function () {
  // Detect IE using conditional compilation
  if (/*@cc_on@*//*@if (@_win32)!/*@end@*/false) {
    // Translations for attribute names which IE would otherwise choke on
    var attrTranslations =
    {
    	"class": "className",
    	"for": "htmlFor"
    };
    var setAttribute = function (element, attr, value) {
    	if (attrTranslations.hasOwnProperty(attr)) {
    		element[attrTranslations[attr]] = value;
    	}
    	else if (attr == "style") {
    		element.style.cssText = value;
    	}
    	else {
    		element.setAttribute(attr, value);
    	}
    };
    return function (tagName, attributes) {
    	attributes = attributes || {};
      // See http://channel9.msdn.com/Wiki/InternetExplorerProgrammingBugs
      if (attributes.hasOwnProperty("name") ||
      	attributes.hasOwnProperty("checked") ||
      	attributes.hasOwnProperty("multiple")) {
      	var tagParts = ["<" + tagName];
      if (attributes.hasOwnProperty("name")) {
      	tagParts[tagParts.length] = ' name="' + attributes.name + '"';
      	delete attributes.name;
      }
      if (attributes.hasOwnProperty("checked") &&
      	"" + attributes.checked == "true") {
      	tagParts[tagParts.length] = " checked";
      delete attributes.checked;
  }
  if (attributes.hasOwnProperty("multiple") &&
  	"" + attributes.multiple == "true") {
  	tagParts[tagParts.length] = " multiple";
  delete attributes.multiple;
}
tagParts[tagParts.length] = ">";
var element =
document.createElement(tagParts.join(""));
}
else {
	var element = document.createElement(tagName);
}
for (var attr in attributes) {
	if (attributes.hasOwnProperty(attr)) {
		setAttribute(element, attr, attributes[attr]);
	}
}
return element;
};
}
  // All other browsers
  else {
  	return function (tagName, attributes) {
  		attributes = attributes || {};
  		var element = document.createElement(tagName);
  		for (var attr in attributes) {
  			if (attributes.hasOwnProperty(attr)) {
  				element.setAttribute(attr, attributes[attr]);
  			}
  		}
  		return element;
  	};
  }
})();
function postToURL(url, values) {
	values = values || {};
	var form = createElement("form", { action: url,
		method: "POST",
		style: "display: none"
	});
	for (var property in values) {
		if (values.hasOwnProperty(property)) {
			var value = values[property];
			if (value instanceof Array) {
				for (var i = 0, l = value.length; i < l; i++) {
					form.appendChild(createElement("input", 
						{ type: "hidden",
						name: property,
						value: value[i]
					}));
				}
			}
			else {
				form.appendChild(createElement("input", { type: "hidden",
					name: property,
					value: value
				}));
			}
		}
	}
	document.body.appendChild(form);
	//console.log(form)
	form.submit();
	document.body.removeChild(form);
}
function validatePayFastResponse(payFastUrl, merchantId) {
  // Incomplete, would be a good idea to add some sort of callback here to validate the payment.
  if (merchantId != getParameter('merchant_id')) {
  	alert('Invalid merchant ID in the response.');
  	return false;
  }
}
function quickPostPaymentToPayFast(payFastUrl) {
	console.log('working')
  // Input filds with the specifid names must be present in the page, whether hidden or as user input, the gateway does validation as well if you don't do it yourself.
  postPaymentToPayFast(payFastUrl,
  	document.getElementById('merchant_id').value, 
  	document.getElementById('merchant_key').value, 
  	document.getElementById('return_url').value, 
  	document.getElementById('cancel_url').value,
  	document.getElementById('notify_url').value,
  	document.getElementById('name_first').value,
  	document.getElementById('name_last').value,
  	document.getElementById('email_address').value,
  	document.getElementById('payment_id').value,
  	document.getElementById('amount').value,
  	document.getElementById('item_name').value,
  	document.getElementById('item_description').value,
  	document.getElementById('email_confirmation').value, 
  	document.getElementById('confirmation_address').value,
  	document.getElementById('subscription_type').value,
  	document.getElementById('frequency').value,
  	document.getElementById('cycles').value,
  	document.getElementById('custom_str1').value,
  	document.getElementById('custom_str2').value
  	);
}
function postPaymentToPayFast(payFastUrl, merchantId, merchantKey, returnUrl, cancelUrl, notifyUrl,
	nameFirst, nameLast, emailAddress, paymentId, amount, itemName, itemDescription,
	emailConfirmation, confirmationAddress,subscription_type,frequency,cycles,custom_str1,custom_str2) {
	postToURL(payFastUrl, {'merchant_id':merchantId, 
		'merchant_key':merchantKey,
		'return_url':returnUrl,
		'cancel_url':cancelUrl,
		'notify_url':notifyUrl,
		'name_first':nameFirst,
		'name_last':nameLast,
		'email_address':emailAddress,
		'm_payment_id':paymentId,
		'amount':amount,
		'item_name':itemName,
		'item_description':itemDescription,
		'email_confirmation':emailConfirmation,
		'confirmation_address':confirmationAddress,
		'subscription_type':subscription_type,
		'frequency':frequency,
		'cycles':cycles,
		"custom_str1":custom_str1,
		"custom_str2":custom_str2,
	});
}
</script>


<script type="text/javascript">
	  var amount = '100.00'
/////////////////////////////
//////  INTITIALIZE  ///////
///////////////////////////
$('document').ready(function(){
  buttonUpdate(amount)
})


$('#custom_str2').change(function(){
  buttonUpdate(amount)
})

////////////////////////////////
//////  ADD THE BUTTON  ///////
//////////////////////////////
function buttonUpdate(amount){
    var billingname = $('#custom_str2').val()
  $('#buttonss').html( '<a href="{{URLPAYFAST}}?cmd=_paynow&amp;receiver={{MERCHANTIDPAYFAST}}&amp;item_name=Subscription&amp;item_description=Subscribe+to+this+site.&amp;amount='+amount+'&amp;return_url={{website}}organizations/new-payfast-step3/{{organization.entry.name}}&amp;cancel_url={{website}}payment_org_cancelled&amp;notify_url={{website}}payment_org_notify&amp;cycles=0&amp;frequency=6&amp;m_subscription_id=pay_now_12600984&amp;m_payment_id={{organization._id}}&amp;payment_id={{organization._id}}&amp;custom_str1={{{user.email}}}&amp;custom_str2='+billingname+'&amp;subscription_type=1"><img src="https://www.payfast.co.za/images/buttons/dark-large-subscribe.png" width="210" height="59" alt="Subscribe" title="Subscribe Now with PayFast"  /></a>')
}
</script>