{{#if username}}
<br><br>
<div class="alert alert-danger" role="alert">
  This list is <strong>{{status}}</strong>  issues for <strong>{{username}}</strong>
</div>
{{/if}}
{{#if getallissues}}
{{#ifEquals status 'closed'}}
{{#ifEquals closedCount '0'}}
<br><br>
<div class="alert alert-warning" role="alert">
  <strong>Heads up!</strong> This list of <strong>{{status}}</strong>  issues is empty.
</div>
<br><br>
<script type="text/javascript">
  $(document).ready(function () {
    $('#tableHolder_{{ids}}_{{status}}').html('')
  })    
</script>
{{/ifEquals}}
{{/ifEquals}}
{{#ifEquals status 'open'}}
{{#ifEquals openCount '0'}}
<br><br>
<div class="alert alert-warning" role="alert">
  <strong>Heads up!</strong> This list of <strong>{{status}}</strong>  issues is empty.
</div>
<br><br>
<script type="text/javascript">
  $(document).ready(function () {
    $('#tableHolder_{{ids}}_{{status}}').html('')
  })    
</script>
{{/ifEquals}}
{{/ifEquals}}
<div id="tableHolder_{{ids}}_{{status}}">
  <table class="table " id="{{ids}}_{{status}}" style="max-width: 100%">
    <thead>
      <tr>
        <th></th>
        <th><i class="text-success fas fa-exclamation-circle"></i> {{openCount}} Open | <i
          class="text-danger fas fa-ban"> </i> {{closedCount}} Closed</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {{#each getallissues}}
        {{#ifEquals this.active ../status}}
        <tr>
          <td style=" min-width: 35px">
            {{#if this.username}}
            <a href="/users/{{username}}">
              <img id="{{username}}" src="https://www.gravatar.com/avatar/{{user._id}}?s=92&d=retro&r=G" class="img-fluid mr-1 userpic" style="border-radius: 4px;max-width:75px">
            </a>
            {{else}}
            {{>randompicsm}} 
            {{/if}}              
          </td>
          <td>
            <div class="row">
              <div class="col-md-11"> <h5>
                {{#if this.title}}
                {{#if this.parentid}}
                <a href="/issues/view/{{this.parentid}}">{{this.title}}</a>  <span class="badge badge-secondary">{{this.parentid}}</span>
                {{else}}
                <a href="/issues/view/">{{this.title}}</a>   
                {{/if}}
                
                {{else}}
                No title
                {{/if}}
                {{#ifEquals this.active 'open'}}
                <i class="text-success fas fa-exclamation-circle"></i>
                {{else}}
                <i class="text-danger fas fa-ban"></i>
                {{/ifEquals}}
              </h5>
              <small>Opened {{this.created}} by
                {{#if this.username}}
                <a href="/users/{{this.username}}">{{this.username}}</a>
                {{else}}
                anonymous
                {{/if}}
              </small>
              <br><p></p>
              <p>{{description}}</p>
            </div>

          </div>
        </td>
        <td>            <div class="col-md-1">
              {{#if ../user}}
              <div  class="dropdown">
                <a class="btn btn-outline-secondary btn-sm " href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                 <i class="fas fa-ellipsis-h"></i>
               </a>
               <div class="dropdown-menu  dropdown-menu-right dropdown-menu-lg-left " aria-labelledby="dropdownMenuLink">
                <a class="dropdown-item" href="/issues/update/{{this._id}}">Edit</a>
                {{#ifEquals this.active 'open'}}
                <a class="dropdown-item" onclick="alertCloseIssue(this.id)" href="#" id="{{this._id}}_close" =>Mark as closed</a>
                {{/ifEquals}}
                <a class="dropdown-item text-danger" onclick="alertDeleteIssue(this.id)" href="#" id="{{this._id}}_close">Delete</a>
              </div>
            </div>
            {{/if}}
            <script type="text/javascript">
                //Handles alert for the for the close issue button.
                function alertCloseIssue(ids){
                  ids = ids.replace('_close','');
                  msg = 'Are you sure you want to close this issue?'
                  var result = confirm(msg);
                  if( result ){
                    //console.log('/issues/view/{{parentid}}/close/'+ids)
                    location.replace('/issues/close/'+ids+'/{{parentid}}')
                  }
                }
                //Handles alert for the for the delete issue button.
                function alertDeleteIssue(ids){
                  ids = ids.replace('_close','');
                  msg = 'Are you sure you want to delete this issue?'
                  var result = confirm(msg);
                  if( result ){
                    location.replace('/issues/delete/'+ids+'/{{parentid}}')
                  }
                }                
              </script>
            </div></td>
      </tr>
      {{/ifEquals}}
      {{/each}}
    </tbody>
  </table> 
</div>
<script type="text/javascript">

  $(document).ready(function () {
   var tableid = '{{ids}}_{{status}}'   
   var table = $('#'+tableid).DataTable({
    'destroy': true,
    "pagingType": "numbers",
    "dom": 'Bfrtip', "autoWidth": true,
    "buttons": [],
        "columnDefs": [
        { "targets": [0,2], "searchable": false ,"orderable": false}
    ],
    "drawCallback": function(  ) {
     getalluserpic('userpic')
   }
 });
   
 })
  function getalluserpic(classtest){
    var idArray = [];
    $('.'+classtest).each(function () {
      idArray.push(this.id);
    });

    function getUnique(array){
        var uniqueArray = [];
        
        // Loop through array values
        for(i=0; i < array.length; i++){
            if(uniqueArray.indexOf(array[i]) === -1) {
                uniqueArray.push(array[i]);
            }
        }
        return uniqueArray;
    }
    
    
    var idArray = getUnique(idArray)




 
    console.log(idArray)
    for (var i = 0; i < idArray.length; i++) {
      userPicLoad(idArray[i],classtest)
    }
  }
  function userPicLoad(id,classtest){
    jQuery.ajax({
      'url': '/profilepic/'+id,
      'async': true,
      'global': false,
      'success': function (dataSchemaObject) {
        $('.'+classtest).each(function () {
          if(this.id == id){
             $(this).attr('src', JSON.parse(dataSchemaObject.image));
          }
         
        });         
      }
    })
  }
</script>
{{else}}
<br><br>
<div class="alert alert-warning" role="alert">
  <strong>Heads up!</strong> This list of <strong>{{status}}</strong> issues is empty.
</div>
<br><br>
{{/if}}
